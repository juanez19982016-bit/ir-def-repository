name: "Tier 2: TONE3000 Amps & IRs"

on:
  workflow_dispatch:
  workflow_call:

jobs:
  download-tone3000-amps:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Install rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << 'EOF'
          [gdrive_repo]
          type = drive
          scope = drive
          token = ${{ secrets.RCLONE_DRIVE_TOKEN }}
          team_drive = 
          EOF

      - name: Download existing cache from Drive
        run: |
          rclone copy gdrive_repo:IR_DEF_REPOSITORY/.download_cache.json /tmp/ir_repository/ || true

      - name: Download TONE3000 Amps & IRs
        env:
          TONE3000_API_KEY: ${{ secrets.TONE3000_API_KEY }}
        run: |
          python scripts/download_and_organize.py \
            --tier tone3000-amps \
            --output-dir /tmp/ir_repository

      - name: Show stats
        run: |
          echo "=== File counts ==="
          find /tmp/ir_repository -type f -not -name '.*' | wc -l
          echo "=== Disk usage ==="
          du -sh /tmp/ir_repository/ 2>/dev/null || true
          echo "=== Category breakdown ==="
          for d in /tmp/ir_repository/*/; do
            echo "$(basename $d): $(find $d -type f | wc -l) files"
          done

      - name: Upload to Google Drive  
        run: |
          rclone copy /tmp/ir_repository gdrive_repo:IR_DEF_REPOSITORY \
            --transfers 8 \
            --checkers 16 \
            --drive-chunk-size 64M \
            --fast-list \
            --stats 30s \
            --log-level INFO \
            -v

      - name: Verify
        run: |
          rclone size gdrive_repo:IR_DEF_REPOSITORY || true
