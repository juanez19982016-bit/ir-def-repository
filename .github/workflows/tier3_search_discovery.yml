name: "Tier 3: Search + Validate + Report"

on:
  workflow_dispatch:
  workflow_call:

jobs:
  search-and-report:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests

      - name: Install rclone
        run: curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone
        env:
          RCLONE_CONFIG_B64: ${{ secrets.RCLONE_CONFIG_B64 }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG_B64" | base64 -d > ~/.config/rclone/rclone.conf
          rclone listremotes

      - name: Download cache
        run: |
          mkdir -p /tmp/ir_repository
          rclone copy gdrive2:IR_DEF_REPOSITORY/.download_cache.json /tmp/ir_repository/ 2>/dev/null || true

      - name: "ğŸ” GitHub Search â€” Auto-discover new repos"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/mega_download.py \
            --tier search \
            --output-dir /tmp/ir_repository

      - name: "ğŸ“¤ Upload search discovery files"
        if: always()
        run: |
          rclone copy /tmp/ir_repository gdrive2:IR_DEF_REPOSITORY \
            --transfers 8 --checkers 16 --drive-chunk-size 64M \
            --fast-list --stats 30s --log-level INFO --stats-one-line \
            --exclude ".*" --exclude "*.log" --exclude "*.json" --exclude "*.md"

      - name: "ğŸ§¹ Final cleanup on Drive"
        if: always()
        run: |
          echo "Removing junk from Drive..."
          rclone delete gdrive2:IR_DEF_REPOSITORY --include "*.json" || true
          rclone delete gdrive2:IR_DEF_REPOSITORY --include "*.log" || true
          rclone delete gdrive2:IR_DEF_REPOSITORY --include "*.md" || true
          rclone delete gdrive2:IR_DEF_REPOSITORY --include "*.txt" || true
          rclone delete gdrive2:IR_DEF_REPOSITORY --include "*.py" || true
          rclone rmdirs gdrive2:IR_DEF_REPOSITORY || true

      - name: "ğŸ“Š FINAL REPORT"
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ¸ IR DEF REPOSITORY â€” FINAL STATE"
          echo "=========================================="
          rclone size gdrive2:IR_DEF_REPOSITORY || true
          echo "------------------------------------------"
          for d in $(rclone lsd gdrive2:IR_DEF_REPOSITORY 2>/dev/null | awk '{print $NF}'); do
            count=$(rclone ls "gdrive2:IR_DEF_REPOSITORY/$d" 2>/dev/null | wc -l)
            size=$(rclone size "gdrive2:IR_DEF_REPOSITORY/$d" 2>/dev/null | grep "Total size" | awk '{print $3, $4}')
            echo "ğŸ“ $d: $count files ($size)"
          done
          echo "=========================================="
