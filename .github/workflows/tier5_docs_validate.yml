name: "Tier 5: Docs and Validate"

on:
  workflow_dispatch:
  workflow_call:

jobs:
  docs-validate:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Install rclone
        run: curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone
        env:
          RCLONE_CONFIG_B64: ${{ secrets.RCLONE_CONFIG_B64 }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG_B64" | base64 -d > ~/.config/rclone/rclone.conf
          rclone listremotes

      - name: Download all content to validate and count
        run: |
          mkdir -p /tmp/ir_repository
          rclone copy gdrive_repo:IR_DEF_REPOSITORY /tmp/ir_repository/ \
            --include "*.wav" --include "*.nam" \
            --transfers 16 \
            --fast-list || true
          echo "=== Downloaded for validation ==="
          find /tmp/ir_repository -type f \( -name '*.wav' -o -name '*.nam' \) | wc -l

      - name: Validate files
        run: |
          python scripts/download_and_organize.py \
            --validate-only \
            --output-dir /tmp/ir_repository

      - name: Generate documentation
        run: |
          python scripts/download_and_organize.py \
            --tier docs \
            --output-dir /tmp/ir_repository

      - name: Upload docs to Drive
        if: always()
        run: |
          rclone copy /tmp/ir_repository/README.md gdrive_repo:IR_DEF_REPOSITORY/ || true

      - name: Final Report
        if: always()
        run: |
          echo "=========================================="
          echo "IR DEF REPOSITORY - FINAL REPORT"
          echo "=========================================="
          rclone size gdrive_repo:IR_DEF_REPOSITORY || true
          echo "=========================================="
          rclone lsd gdrive_repo:IR_DEF_REPOSITORY || true
          echo "=========================================="
          echo "DONE!"
