name: "Tier 5: Generate Docs & Final Validate"

on:
  workflow_dispatch:
  workflow_call:

jobs:
  docs-validate:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Install rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone
        env:
          RCLONE_TOKEN: ${{ secrets.RCLONE_DRIVE_TOKEN }}
        run: |
          mkdir -p ~/.config/rclone
          printf "[gdrive_repo]
type = drive
scope = drive
token = %s
team_drive =
" "$RCLONE_TOKEN" > ~/.config/rclone/rclone.conf

      - name: Download repository from Drive for doc generation
        run: |
          mkdir -p /tmp/ir_repository
          # Only download the metadata cache and a file listing
          rclone copy gdrive_repo:IR_DEF_REPOSITORY/.download_cache.json /tmp/ir_repository/ || true
          rclone copy gdrive_repo:IR_DEF_REPOSITORY/.stats.json /tmp/ir_repository/ || true
          # Get the full file listing for documentation
          rclone lsf gdrive_repo:IR_DEF_REPOSITORY -R --files-only > /tmp/drive_files.txt || true
          echo "Total files on Drive:"
          wc -l < /tmp/drive_files.txt

      - name: Generate documentation from Drive listing
        run: |
          python3 << 'PYEOF'
          import os
          from pathlib import Path
          from collections import defaultdict

          base = Path("/tmp/ir_repository")
          base.mkdir(parents=True, exist_ok=True)

          # Read file listing from Drive
          files = []
          listing = Path("/tmp/drive_files.txt")
          if listing.exists():
              files = [l.strip() for l in listing.read_text().splitlines() if l.strip()]

          # Filter only audio files
          valid_ext = {".wav", ".nam", ".json", ".aidax", ".flac", ".aiff"}
          audio_files = [f for f in files if Path(f).suffix.lower() in valid_ext]
          total = len(audio_files)

          # Categorize
          categories = defaultdict(int)
          brands = defaultdict(int)
          for f in audio_files:
              parts = f.replace("\\", "/").split("/")
              if len(parts) >= 2:
                  categories[f"{parts[0]}/{parts[1]}"] += 1
              if len(parts) >= 3:
                  brands[parts[2]] += 1

          # README
          readme = f"""# ðŸŽ¸ IR DEF REPOSITORY â€” The Ultimate Free IR & NAM Collection

          > **{total:,} archivos** de Impulse Responses y capturas Neural Amp Modeler
          > Organizado por instrumento, tipo y marca â€” 100% gratuito y legal
          > Compilado de 30+ fuentes verificadas de la comunidad

          ---

          ## ðŸ“Š EstadÃ­sticas

          | CategorÃ­a | Archivos |
          |-----------|----------|
          """
          for cat in sorted(categories):
              readme += f"| {cat} | {categories[cat]:,} |\n"
          readme += f"| **TOTAL** | **{total:,}** |\n"

          readme += """
          ---

          ## ðŸ“‚ Estructura

          ```
          â”œâ”€â”€ GUITARRA/          â€” IRs y capturas NAM de guitarra
          â”‚   â”œâ”€â”€ IRs/           â€” Impulse Responses (WAV) por marca
          â”‚   â””â”€â”€ NAM_Capturas/  â€” Modelos NAM (Amps/Pedals/Full_Rigs) por marca
          â”œâ”€â”€ BAJO/              â€” IRs y capturas NAM para bajo
          â”œâ”€â”€ ELECTROACUSTICA/   â€” IRs piezo y simulaciÃ³n acÃºstica
          â””â”€â”€ UTILIDADES/        â€” Reverbs, emulaciones de mic, favoritos
          ```

          ## ðŸš€ Quick Start â†’ [QUICK_START.md](QUICK_START.md)
          ## ðŸ“‹ Fuentes â†’ [SOURCES.md](SOURCES.md)

          ---
          *Repositorio auto-generado â€” Todas las fuentes son gratuitas y legÃ­timas*
          """
          import textwrap
          readme = textwrap.dedent(readme)
          (base / "README.md").write_text(readme, encoding="utf-8")
          print(f"README generated for {total:,} files")

          PYEOF

      - name: Copy static docs
        run: |
          # Generate QUICK_START and SOURCES via the script
          python scripts/download_and_organize.py \
            --tier docs \
            --output-dir /tmp/ir_repository || true

      - name: Upload docs to Drive
        run: |
          rclone copy /tmp/ir_repository/README.md gdrive_repo:IR_DEF_REPOSITORY/ || true
          rclone copy /tmp/ir_repository/QUICK_START.md gdrive_repo:IR_DEF_REPOSITORY/ || true
          rclone copy /tmp/ir_repository/SOURCES.md gdrive_repo:IR_DEF_REPOSITORY/ || true

      - name: Final Report
        run: |
          echo "============================================"
          echo "   IR DEF REPOSITORY â€” FINAL REPORT"
          echo "============================================"
          rclone size gdrive_repo:IR_DEF_REPOSITORY 2>/dev/null || echo "Size check pending"
          echo ""
          echo "=== Top-level folders ==="
          rclone lsd gdrive_repo:IR_DEF_REPOSITORY/ 2>/dev/null || true
          echo ""
          echo "============================================"
          echo "   DONE! Repository is ready to share."
          echo "============================================"
