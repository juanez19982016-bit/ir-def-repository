name: "Tier 3: Search Discovery + Docs"

on:
  workflow_dispatch:
  workflow_call:

jobs:
  download-search:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests

      - name: Install rclone
        run: curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone
        env:
          RCLONE_CONFIG_B64: ${{ secrets.RCLONE_CONFIG_B64 }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG_B64" | base64 -d > ~/.config/rclone/rclone.conf
          echo "=== Available remotes ==="
          rclone listremotes

      - name: Download cache from Drive
        run: |
          mkdir -p /tmp/ir_repository
          rclone copy gdrive2:IR_DEF_REPOSITORY/.download_cache.json /tmp/ir_repository/ 2>/dev/null || true
          if [ -f /tmp/ir_repository/.download_cache.json ]; then
            echo "Cache loaded: $(wc -c < /tmp/ir_repository/.download_cache.json) bytes"
          else
            echo "No cache found, starting fresh"
          fi

      - name: Download existing files from Drive (for docs)
        run: |
          rclone copy gdrive2:IR_DEF_REPOSITORY /tmp/ir_repository \
            --transfers 8 --checkers 16 --fast-list \
            --include "*.wav" --include "*.nam" \
            --max-size 50M \
            || true

      - name: GitHub Search Auto-Discovery
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/mega_download.py \
            --tier search \
            --output-dir /tmp/ir_repository

      - name: Validate all files
        run: |
          python scripts/mega_download.py \
            --validate-only \
            --output-dir /tmp/ir_repository

      - name: Generate docs
        run: |
          python scripts/mega_download.py \
            --tier docs \
            --output-dir /tmp/ir_repository

      - name: Final Stats
        if: always()
        run: |
          echo "=========================================="
          echo "FINAL REPOSITORY STATS"
          echo "=========================================="
          for d in /tmp/ir_repository/*/; do
            [ -d "$d" ] && echo "$(basename $d): $(find $d -type f \( -name '*.wav' -o -name '*.nam' \) 2>/dev/null | wc -l)"
          done
          echo "------------------------------------------"
          echo "TOTAL: $(find /tmp/ir_repository -type f \( -name '*.wav' -o -name '*.nam' \) 2>/dev/null | wc -l)"
          echo "=========================================="

      - name: Upload to Google Drive (second account)
        if: always()
        run: |
          echo "Final upload to gdrive2..."
          rclone copy /tmp/ir_repository gdrive2:IR_DEF_REPOSITORY \
            --transfers 8 --checkers 16 --drive-chunk-size 64M \
            --fast-list --stats 30s --log-level INFO --stats-one-line \
            --exclude ".download.log"
          echo "Upload complete!"

      - name: Final Drive Report
        if: always()
        run: |
          echo "=========================================="
          echo "GOOGLE DRIVE FINAL STATE"
          echo "=========================================="
          rclone size gdrive2:IR_DEF_REPOSITORY || true
          echo "------------------------------------------"
          rclone lsd gdrive2:IR_DEF_REPOSITORY || true
          echo "=========================================="
